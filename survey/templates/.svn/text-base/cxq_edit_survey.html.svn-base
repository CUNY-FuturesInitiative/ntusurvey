{% extends "cxq_base.html" %}
{% comment %}
For edit:
    SurveyID.
    Title
    Description
    For each question:


{% endcomment %}
{% block title %} Add question {% endblock %}
{% block script %}
    <style>
        #question_container {
            width: 700px;
        }

        .ui-state-highlight {
            height: 1.5em;
            line-height: 1.2em;
        }

        .singleQuestionDiv {
            float: left;
            clear: left;
            width: 600px;
        }

        .pink_background {
            background-color: #ffc0cb;
        }

        .hideable {
            display: none;
        }

        .questionDiv {
            width: 700px;
        }

        .buttonDiv {
            float: right;
            vertical-align: middle;
            text-align: center;
            line-height: 20px;
        }

        .buttonDiv button {
            width: 80px;
        }

        .clearBoth {
            clear: both;
        }

    </style>
    <link rel="stylesheet" href="http://code.jquery.com/ui/1.9.0/themes/base/jquery-ui.css"/>
    <script src="http://code.jquery.com/jquery-1.8.2.js"></script>
    <script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js"></script>
    <script>
    {#    edit#}
    {% if surveyID %}
        surveyID = {{ surveyID }};
    {% endif %}
    $(function () {
        fetchQuestions();
        useEditable();
        $("#addButton").click(function () {
            $.post('/add_component/',
                    {
                        question_type:$('#add_list').val(),
                        max_length:$('#max_length').val(),
                        group_name:$('#group_name').val(),
                    },
                    function (result) {
                        createQuestion(result.content, $('#add_list').val());
                    }, "json");
        });
        $("#saveSurveyButton").click(function () {
            total = $(".questionDiv").length;
            if (total == 0) {
                alert("empty survey");
                return;
            }

            {% comment %}edit{% endcomment %}
            if (surveyID != 0) {
                $.post("/delete_survey_cxq/",
                        {
                            surveyID:surveyID,
                        },
                        function (result) {
                        }, "json");
            }
            surveyTitle = $("#survey_title").text();
            surveyDescription = $("#survey_description").text();
            $.post("/create_survey_cxq/",
                    {
                        survey_title:surveyTitle,
                        survey_description:surveyDescription,
                    },
                    function (result) {
                        surveyID = result.surveyID;
                        saveSurvey();
                    }, "json");


        });

    })
    function fetchQuestions() {
    {% for question in survey.questions.all %}
        $.post('/add_component/',
                {
                    question_type:'{{ question.type }}',
                    question_description:'{{ question.title }}',
                    question_helptext:'{{ question.helptext }}',
                    questionID:"{{ question.id }}"
                },
                function (result) {
                    createQuestion(result.content, "{{ question.type }}");
                }, "json");
    {% endfor %}
    }
    function saveSurvey() {
        for (var i = 1; i <= total; i++) {
            var curQuestionDiv = $(".questionDiv:nth-child(" + i + ")");
            var questionNo = curQuestionDiv.find(".question_no").text();
            questionNo = questionNo.slice(1, -1);
            var questionTitle = curQuestionDiv.find(".question_description").text();
            var questionHelptext = curQuestionDiv.find(".question_helptext").text();
            if (questionHelptext == "Click here to add help text")
                questionHelptext = "";
            if (questionHelptext == "Click to add...")
                questionHelptext = "";
            var questionType = "";
            if (curQuestionDiv.hasClass("paragraph"))
                questionType = "paragraph";
            else if (curQuestionDiv.hasClass("numeric"))
                questionType = "numeric";
            else if (curQuestionDiv.hasClass("multiplechoice"))
                questionType = "multiplechoice";
            else if (curQuestionDiv.hasClass("checkbox"))
                questionType = "checkbox";
            var selections = curQuestionDiv.find(".selection").find("span").text(function (index, text) {
                return text + "@#@"
            }).text();
            curQuestionDiv.find(".selection").find("span").text(function (index, text) {
                return text.slice(0, -3);
            });
            var attributes_no = 0;
            attributes_no = curQuestionDiv.find("#attributes").find("input").length;
            var attributes = "";
            for (var j = 1; j <= attributes_no; j++) {
                attributes += curQuestionDiv.find("#attributes").find("input:nth-child(" + (j * 2 - 1) + ")").val();
                attributes += "@#@";
            }

            $.post("/" + surveyID + "/cxq_save_survey/",
                    {
                        question_type:questionType,
                        question_no:questionNo,
                        question_helptext:questionHelptext,
                        question_title:questionTitle,
                        selections:selections,
                        attributes:attributes,
                    },
                    function (result) {
                        surveyID = result.surveyID;
                    }, "json");

        }
        alert("Finish! Now we should redirect to next page!")
    }
    function createQuestion(html, type) {
        container = document.getElementById('question_container');
        questionDiv = document.createElement("div");
        $(questionDiv).html(html).attr('name', "questionDiv").addClass("questionDiv").addClass(type);
        container.appendChild(questionDiv);
        //Number the new Question
        numberQuestionDiv(questionDiv);
        // make text editable
        useEditable();
        // make questions sortable
        $(".sortable").sortable({
            placeholder:"ui-state-highlight"
        });
        $(".sortable").disableSelection();
        // make it responsive to click
        $(questionDiv).click(function () {
            if ($(this).find(".singleQuestionDiv").hasClass("pink_background"))
                return;
            if ($("div.pink_background .question_helptext").text() == "")
                $("div.pink_background .question_helptext").text("Click here to add...");
            if ($("div.pink_background .question_helptext").text() != "Click here to add..." &&
                    $("div.pink_background .question_helptext").text() != "Click here to add help text") {
                $("div.pink_background .question_helptext").removeClass("hideable");
            }
            else {
                $("div.pink_background .question_helptext").addClass("hideable");
            }
            $("div.pink_background .hideable").hide('slow');
            $(this).siblings().find(".buttonDiv").hide('slow');
            $(this).find(".buttonDiv").show('slow');
            $(this).find(".singleQuestionDiv").addClass("pink_background");
            $(this).siblings().find(".singleQuestionDiv").removeClass("pink_background");
            $(this).find(".hideable").show('slow');
        });
        //add confirm and delete button;
        buttonDiv = document.createElement("div");
        questionDiv.appendChild(buttonDiv);
        $(buttonDiv).addClass('buttonDiv').hide();
        br = document.createElement("br");
        upButton = document.createElement("button");
        confirmButton = document.createElement("button");
        deleteButton = document.createElement("button");
        downButton = document.createElement("button");
        $(upButton).text('up');
        $(confirmButton).text('Confirm');
        $(deleteButton).text('Delete');
        $(downButton).text("down")
        buttonDiv.appendChild(upButton);
        buttonDiv.appendChild(confirmButton);
        buttonDiv.appendChild(deleteButton);
        buttonDiv.appendChild(downButton);
        $(buttonDiv).find("button").after("<br />")
        //make button responsive to click
        $(confirmButton).click(function (e) {
            if ($("div.pink_background .question_helptext").text() == "")
                $("div.pink_background .question_helptext").text("Click here to add help text");
            if ($("div.pink_background .question_helptext").text() != "Click here to add help text") {
                $("div.pink_background .question_helptext").removeClass("hideable");
            }
            else {
                $("div.pink_background .question_helptext").addClass("hideable");
            }
            $("div.pink_background .hideable").hide('slow');
            $("div.pink_background").removeClass("pink_background");
            $(this).parent().hide("slow");
            e.stopPropagation();
        });
        $(deleteButton).click(function () {
            $(".pink_background").parent().hide('slow', function () {
                $(this).remove();
                reNumberAll();
            });
        });
        $(upButton).click(function () {
            curQuestionDiv = $(".pink_background").parent()
            curQuestionNo = $(curQuestionDiv).find(".question_no").text().slice(1, -1);
            if (curQuestionNo == 1)
                return;
            prevQuestionDiv = $(".questionDiv:nth-child(" + (curQuestionNo - 1) + ")");
            $(prevQuestionDiv).before($(curQuestionDiv));
            reNumberAll();
        });
        $(downButton).click(function () {
            curQuestionDiv = $(".pink_background").parent()
            curQuestionNo = $(curQuestionDiv).find(".question_no").text().slice(1, -1);
            if (curQuestionNo == $(".questionDiv").length)
                return;
            nextQuestionDiv = $(".questionDiv:nth-child(" + (Number(curQuestionNo) + 1) + ")");
            $(nextQuestionDiv).after($(curQuestionDiv));
            reNumberAll();
        });
        // for add new selection button
        $(questionDiv).find(".addNewSelection").click(function () {
            var curQuestionDiv = $(".pink_background.singleQuestionDiv").parent();
            singleSelection = curQuestionDiv.find(".selection:first").clone()
            singleSelection.find("span").text("sample").addClass("editable");
            singleSelection.appendTo(curQuestionDiv.find(".selections_container"));
            useEditable();
            selectionDeletable(singleSelection);
            singleSelection.mouseout(function (event) {
                selectionMouseout(event, this);
            });
            singleSelection.mouseover(function (event) {
                selectionMouseover(event, this);
            });
        });
        $(questionDiv).find(".selection").mouseover(function (event) {
            selectionMouseover(event, this);
        });
        $(questionDiv).find(".selection").mouseout(function (event) {
            selectionMouseout(event, this);
        });
    }
    function selectionDeletable(singleSelection) {
        $("<button>Delete</button>").appendTo(singleSelection).click(function () {
            if ($(".selections_container").has($(this)).find(".selection").length == 1)
                return;
            $(this).parent().remove();
        });
    }
    function selectionMouseover(event, selection) {
        var event = event || window.event;
        if (event) {
            if (selection.contains(event.relatedTarget || event.toElement)) {
                return;
            }
            selectionDeletable(selection);
        }
    }
    function selectionMouseout(event, selection) {
        var event = event || window.event;
        if (event) {
            if (selection.contains(event.relatedTarget || event.toElement)) {
                return;
            }
            $(selection).find("button").remove();
        }
    }
    function numberQuestionDiv(questionDiv) {
        n = $("span.question_no").length;
        $(questionDiv).find("span.question_no").text("Q" + n + ":");
    }
    function reNumberAll() {
        n = $(".questionDiv").length;
        for (var i = 1; i <= n; i++)
            $(".questionDiv:nth-child(" + i + ")").find("span.question_no").text("Q" + i + ":");
    }
    function useEditable() {
        $(".editable").removeClass('editable').click(function () {
            $("input:focus").focusout();
            currentSpan = $(this);
            content = $(this).text();
            parentDiv = $(this.parentNode);
            editorWidth = content.length * 6;
            if (editorWidth < 60)
                editorWidth = 60;
            if (editorWidth > 600)
                editorWidth = 600;

            editor = $("<input type='text' />");
            editor.css('width', editorWidth.toString() + 'px');
            editor.val(content);


            //  html += "<button>finish</button>"
            editorSpan = $("<span></span>");
            editorSpan.append(editor);
            currentSpan.after(editorSpan);
            currentSpan.hide();
            editor.focus();
            editor.select();
            editor.keypress(function (event) {
                if (event.which == 13)
                    editor.focusout();
            });
            editor.focusout(function () {
                currentSpan.html(editor.val());
                if (currentSpan.text() == "")
                    currentSpan.text("Click here to add...")
                currentSpan.show();
                editorSpan.remove();
            });


        });
    }

    {% comment %}    function typeChange(){
            question_type = $('#add_list').val();
            attr_container = document.getElementById('add_form_attr');
            html = ""
            if (question_type=="paragraph"){
                html = "Max length:<input type='text' id='max_length' value=200 />";
            }
            else if(question_type=="mcq"){
            }
            $(attr_container).html(html)

        }{% endcomment %}
    </script>
{% endblock %}

{% block content %}
    <div id="survey_title" class="editable">{{ title }}</div>
    <div id="survey_description" class="editable">{{ description }}</div>
    <div id="question_container" class=""></div>
    <div class="add_question_div clearBoth">
        <form id="add_form" action="/add_component/" method="POST">
            <select id="add_list" name="add_list">
                <option value="paragraph">paragraph</option>
                <option value="numeric">numberic</option>
                <option value="multiplechoice">Multiple choice quesion</option>
                <option value="checkbox">Check box</option>
            </select>

            <span id="add_form_attr"></span>
            <input type="button" id="addButton" value="add"/>
        </form>
        <button id="saveSurveyButton">Save</button>
        <button>Publish</button>
        <li class="dropdown">
            <button class="btn btn-danger">Theme</button>
            <ul class="dropdown-menu" role="menu" aria-labelledby="username">

                <li><a href="/account/edit_profile"></a></li>
                <li class="divider"></li>
                <li><a href="/account/change_password">Change Password</a></li>
                <li><a tabindex="-1" href="/account/logout">Log out</a></li>
            </ul>


        </li>

    </div>
{% endblock %}